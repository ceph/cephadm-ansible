---
- name: deploy a cluster
  hosts: all
  become: true
  gather_facts: true
  tasks:
    - import_role:
        name: ceph-defaults

    - name: container registry authentication
      command: 'podman login -u {{ ceph_container_registry_username }} --password-stdin {{ ceph_container_registry }}'
      args:
        stdin: '{{ ceph_container_registry_password }}'
        stdin_add_newline: no
      changed_when: false
      environment:
        HTTP_PROXY: "{{ ceph_container_http_proxy | default('') }}"
        HTTPS_PROXY: "{{ ceph_container_https_proxy | default('') }}"
        NO_PROXY: "{{ ceph_container_no_proxy }}"
      when: ceph_container_registry_auth | default(False) | bool

    - name: get the cephadm ssh pub key
      command: "cephadm shell -- ceph --cluster {{ cluster }} cephadm get-pub-key"
      changed_when: false
      run_once: true
      register: cephadm_pubpkey
      delegate_to: '{{ groups["admin"][0] }}'
      environment:
        CEPHADM_IMAGE: '{{ ceph_container_registry }}/{{ ceph_container_image }}:{{ ceph_container_image_tag }}'

    - name: allow cephadm key for root account
      authorized_key:
        user: root
        key: '{{ cephadm_pubpkey.stdout }}'

    - name: run cephadm prepare-host
      command: cephadm prepare-host
      changed_when: false
      environment:
        CEPHADM_IMAGE: '{{ ceph_container_registry }}/{{ ceph_container_image }}:{{ ceph_container_image_tag }}'

    - name: manage nodes with cephadm
      command: "cephadm shell -- ceph --cluster {{ cluster }} orch host add {{ ansible_facts['hostname'] }} {{ ansible_facts['default_ipv4']['address'] }} {{ group_names | join(' ') }} {{ '_admin' if inventory_hostname in groups['admin'] else '' }}"
      changed_when: false
      delegate_to: '{{ groups["admin"][0] }}'
      environment:
        CEPHADM_IMAGE: '{{ ceph_container_registry }}/{{ ceph_container_image }}:{{ ceph_container_image_tag }}'

    - name: add ceph label for core component
      command: "cephadm shell -- ceph --cluster {{ cluster }} orch host label add {{ ansible_facts['hostname'] }} ceph"
      changed_when: false
      delegate_to: '{{ groups["admin"][0] }}'
      environment:
        CEPHADM_IMAGE: '{{ ceph_container_registry }}/{{ ceph_container_image }}:{{ ceph_container_image_tag }}'

- name: adjust service placement
  hosts: "admin[0]"
  become: true
  gather_facts: false
  tasks:
    - import_role:
        name: ceph-defaults

    - name: update the placement of monitor hosts
      command: "cephadm shell -- ceph --cluster {{ cluster }} orch apply mon --placement='label:mons'"
      changed_when: false
      environment:
        CEPHADM_IMAGE: '{{ ceph_container_registry }}/{{ ceph_container_image }}:{{ ceph_container_image_tag }}'

    - name: waiting for the monitor to join the quorum...
      command: "cephadm shell -- ceph --cluster {{ cluster }} quorum_status --format json"
      changed_when: false
      register: ceph_health_raw
      until: (ceph_health_raw.stdout | from_json)["quorum_names"] | length == groups.get('mons', []) | length
      retries: "{{ health_mon_check_retries }}"
      delay: "{{ health_mon_check_delay }}"
      environment:
        CEPHADM_IMAGE: '{{ ceph_container_registry }}/{{ ceph_container_image }}:{{ ceph_container_image_tag }}'

    - name: update the placement of manager hosts
      command: "cephadm shell -- ceph --cluster {{ cluster }} orch apply mgr --placement='label:mgrs'"
      changed_when: false
      environment:
        CEPHADM_IMAGE: '{{ ceph_container_registry }}/{{ ceph_container_image }}:{{ ceph_container_image_tag }}'

    - name: update the placement of osd hosts
      command: "cephadm shell -- ceph --cluster {{ cluster }} orch apply osd --all-available-devices"
      changed_when: false
      environment:
        CEPHADM_IMAGE: '{{ ceph_container_registry }}/{{ ceph_container_image }}:{{ ceph_container_image_tag }}'

    - name: update the placement of crash hosts
      command: "cephadm shell -- ceph --cluster {{ cluster }} orch apply crash --placement='label:ceph'"
      changed_when: false
      environment:
        CEPHADM_IMAGE: '{{ ceph_container_registry }}/{{ ceph_container_image }}:{{ ceph_container_image_tag }}'

